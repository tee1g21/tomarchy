#!/bin/bash

# Locations
LOCATION_0_NAME="Trafford, UK"
LOCATION_0_QUERY="trafford"

LOCATION_1_NAME="Bagshot, UK"
LOCATION_1_QUERY="bagshot"


# Script args
LOCATION_ARGUMENT=${1:-0}

if [ "$LOCATION_ARGUMENT" == "0" ]; then
    NAME=$LOCATION_0_NAME
    QUERY=$LOCATION_0_QUERY
else
    NAME=$LOCATION_1_NAME
    QUERY=$LOCATION_1_QUERY
fi

cache_file="$HOME/.cache/tomarchy/hyprlock-weather/wttr_${QUERY}.txt"
mkdir -p "$(dirname "$cache_file")"

expiry_time=1800 # 30 mins
current_date=$(date +%s)
last_modified=$(stat -c %Y "$cache_file" 2>/dev/null || echo 0)

if [ $((current_date - last_modified)) -lt $expiry_time ] && [ -s "$cache_file" ]; then
    # Output the cached data silently
    cat "$cache_file"
    exit 0
fi

weather=$(curl -s -m 10 "wttr.in/${QUERY}?format=%c+%t" 2>/dev/null | sed 's/+//; s/  */  /g')

if [ -n "$weather" ]; then
    final_string="$NAME | $weather"
    echo "$final_string" > "$cache_file"
    echo "$final_string"
else
    # Fallback to cache if internet is down
    [ -f "$cache_file" ] && cat "$cache_file" || echo "$NAME | Weather Offline"
fi